---
layout: post
title: "UDP简介"
date: 2019-04-03 08:55
comments: false
tags: 
- 网络
categories:	
- 基础
- 网络
---

本文简单介绍UDP协议。

<!--more-->


### UDP的介绍

#### 定义
UDP简单的面向数据报的、不可靠的传输层协议。

#### UDP首部
```
-----------------------------------------------------
|    16位源端口号               |     16位目的端口号  |
 ----------------------------------------------------
|  16位UDP长度（UDP首部+ 数据）  |     16位UDP检验和   |
 -----------------------------------------------------
|                    数据（如果有）                   |
------------------------------------------------------
```


#### UDP包的大小

##### 理论上限
UDP协议中有16位的UDP报文长度，那么UDP报文长度不能超过2^16=65536

##### IP层分片
实际上，对于较长的数据，IP层是会分片的：
> 链路层对数据帧有长度限制，称之为“最大传输单元MTU”。
>
> 如果IP层要传一个数据报，而且数据长度比链路层MTU还大，那么IP层将数据分片，使每一个分片都小于MTU。

##### 局域网环境
以太网(Ethernet)数据帧的长度必须在46-1500字节之间,这是由以太网的物理特性决定的，这个1500字节被称为链路层的MTU(最大传输单元)。所以这个1500字节就是网络层IP数据报的长度限制。

因为IP数据报的首部为20字节，所以IP数据报的数据区长度最大为1480字节。而这个1480字节就是用来放TCP传来的TCP报文段或UDP传来的UDP数据报的。

又因为UDP数据报的首部8字节，所以UDP数据报的数据区最大长度为1472字节。

<font color=green>**在普通的局域网环境下，建议将UDP的数据控制在1472字节以下**</font>。

##### 外网环境
鉴于Internet上的标准MTU值为576字节，<font color=green>**UDP的数据长度控件在548字节(576-8-20)以内**</font>。


#### UDP包的发送和接收

##### UDP的通信有界性
在阻塞模式下，UDP的通信是以数据包作为界限的，即使server端的缓冲区再大也要按照client发包的次数来多次接收数据包

##### UDP数据包的无序性和非可靠性
client依次发送1、2、3三个UDP数据包，server端先后调用3次接收函数，可能会依次收到3、2、1次序的数据包，收包可能是1、2、3的任意排列组合，也可能丢失一个或多个数据包。

##### UDP数据包的接收
client发送两次UDP数据，第一次 500字节，第二次300字节，在假定数据包是不丢失并且是按照发送顺序按序到达的情况下，server端阻塞模式下接包，先后三次调用：recvfrom( 200)，recvfrom( 1000)，recvfrom( 1000)，接收情况如何呢？

由于UDP通信的有界性，第一次recvfrom( 200)将接收第一个500字节的数据包，但是因为用户空间buf只有200字节，于是只会返回前面200字节，剩下300字节将丢弃。第二次recvfrom( 1000)将返回300字节，第三次recvfrom( 1000)将会阻塞。

#### UDP丢包问题
在不考虑UDP下层IP层的分片丢失，CRC检验包不完整的情况下，造成UDP丢包的因素有哪些呢？

##### UDP socket缓冲区满（过小）造成的UDP丢包
如果socket缓冲区满了，应用程序没来得及处理在缓冲区中的UDP包，那么后续来的UDP包会被内核丢弃，造成丢包。

##### ARP缓存过期导致UDP丢包
ARP 的缓存时间约10分钟，APR 缓存列表没有对方的 MAC 地址或缓存过期的时候，会发送 ARP 请求获取 MAC 地址，在没有获取到 MAC 地址之前，用户发送出去的 UDP 数据包会被内核缓存到 arp_queue 这个队列中，默认最多缓存3个包，多余的 UDP 包会被丢弃。

#### UDP的使用场景

##### 对实时性要求高
比如实时会议，实时视频这种情况下，如果使用 TCP，当网络不好发生重传时，画面肯定会有延时，甚至越堆越多。如果使用 UDP 的话，即使偶尔丢了几个包，但是也不会影响什么，这种情况下使用 UDP 比较好；

##### 多点通信
TCP 需要保持一个长连接，那么在涉及多点通讯的时候，肯定需要和多个通信节点建立其双向连接，然后有时在NAT环境下，两个通信节点建立其直接的 TCP 连接不是一个容易的事情，而 UDP 可以无需保持连接，直接发就可以了，所以成本会很低，而且穿透性好。这种情况下使用 UDP 也是没错的。


#### UDP于TCP的简单比较
* TCP：面向连接、面向字节流、可靠的
* UDP：无连接的、面向报文的、不可靠的


